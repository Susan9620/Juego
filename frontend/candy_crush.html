<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Candy Crush</title>
    <style>
        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: url('../assets/Fondo.png') center/cover fixed;
            font-family: system-ui, sans-serif;
            color: #fff;
        }

        #wrapper {
            width: 600px;
            height: 775px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 18px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, .45), 0 2px 12px rgba(0, 0, 0, .6) inset;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
        }

        #game {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
        }

        #info {
            margin-top: 10px;
            font-weight: 700;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <canvas id="game" width="600" height="600"></canvas>
        <div id="info"></div>
    </div>
    <script>
        const ROWS = 8, COLS = 8, SIZE = 75;
        const CANDIES = ['❤️', '🌹', '💌', '🍫', '💘', '💍'];
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        let board = [], selected = null, score = 0, level = 1;
        const BASE = 100;

        function randCandy() { return CANDIES[Math.floor(Math.random() * CANDIES.length)]; }

        function init() {
            board = Array.from({ length: ROWS }, () => Array(COLS).fill(null));
            for (let y = 0; y < ROWS; y++)for (let x = 0; x < COLS; x++) board[y][x] = randCandy();
            while (clearMatches() > 0) { collapse(); fill(); }
            draw();
        }
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '32px serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            for (let y = 0; y < ROWS; y++) {
                for (let x = 0; x < COLS; x++) {
                    ctx.fillStyle = 'rgba(255,255,255,0.6)';
                    ctx.fillRect(x * SIZE, y * SIZE, SIZE, SIZE);
                    ctx.fillText(board[y][x], x * SIZE + SIZE / 2, y * SIZE + SIZE / 2);
                }
            }
            if (selected) {
                ctx.strokeStyle = '#f00';
                ctx.lineWidth = 3;
                ctx.strokeRect(selected.x * SIZE + 2, selected.y * SIZE + 2, SIZE - 4, SIZE - 4);
            }
            document.getElementById('info').textContent = `Puntaje: ${score} / ${target()}  •  Nivel: ${level}/10`;
        }
        function target() { return BASE * Math.pow(2, level - 1); }

        function getTile(e) {
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / SIZE);
            const y = Math.floor((e.clientY - rect.top) / SIZE);
            return { x, y };
        }

        let dragging = false, start = null;
        canvas.addEventListener('mousedown', e => {
            start = getTile(e);
            selected = start;
            dragging = true;
            draw();
        });
        canvas.addEventListener('mouseup', e => {
            if (!dragging) return;
            const end = getTile(e);
            dragging = false;
            if (start && (Math.abs(start.x - end.x) + Math.abs(start.y - end.y) === 1)) {
                swap(start, end);
                const removed = clearMatches();
                if (removed > 0) {
                    collapse();
                    fill();
                    score += removed * 10;
                    checkLevel();
                } else {
                    swap(start, end);
                }
            }
            selected = null;
            draw();
        });

        function swap(a, b) {
            const tmp = board[a.y][a.x];
            board[a.y][a.x] = board[b.y][b.x];
            board[b.y][b.x] = tmp;
        }

        function clearMatches() {
            let remove = Array.from({ length: ROWS }, () => Array(COLS).fill(false));
            let count = 0;
            for (let y = 0; y < ROWS; y++) {
                let run = 1;
                for (let x = 1; x < COLS; x++) {
                    if (board[y][x] === board[y][x - 1]) run++; else { if (run >= 3) for (let k = 0; k < run; k++) remove[y][x - 1 - k] = true; run = 1; }
                }
                if (run >= 3) for (let k = 0; k < run; k++) remove[y][COLS - 1 - k] = true;
            }
            for (let x = 0; x < COLS; x++) {
                let run = 1;
                for (let y = 1; y < ROWS; y++) {
                    if (board[y][x] === board[y - 1][x]) run++; else { if (run >= 3) for (let k = 0; k < run; k++) remove[y - 1 - k][x] = true; run = 1; }
                }
                if (run >= 3) for (let k = 0; k < run; k++) remove[ROWS - 1 - k][x] = true;
            }
            for (let y = 0; y < ROWS; y++) for (let x = 0; x < COLS; x++) if (remove[y][x]) { board[y][x] = null; count++; }
            return count;
        }

        function collapse() {
            for (let x = 0; x < COLS; x++) {
                let col = board.map(row => row[x]).filter(v => v != null);
                while (col.length < ROWS) col.unshift(null);
                for (let y = 0; y < ROWS; y++) board[y][x] = col[y];
            }
        }

        function fill() {
            for (let y = 0; y < ROWS; y++)for (let x = 0; x < COLS; x++) if (board[y][x] == null) board[y][x] = randCandy();
            const cleared = clearMatches();
            if (cleared > 0) { collapse(); fill(); score += cleared * 10; checkLevel(); }
        }

        function checkLevel() {
            if (score >= target()) {
                if (level < 10) { level++; alert('Nivel ' + level); }
                else alert('¡Ganaste!');
            }
        }

        init();
    </script>
</body>

</html>