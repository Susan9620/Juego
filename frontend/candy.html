<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
    <title>Love Crush üíï</title>
    <style>
        :root {
            --acento-1: #ff6b9d;
            --acento-2: #ff8fab;
            --panel: rgba(26, 22, 37, 0.95);
            --texto: #ffe3ea;
            --atenuado: #b8a8c8;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: radial-gradient(1200px 800px at 50% 20%, #1a1625 0%, #0f0f14 60%, #0a0a0d 100%);
            color: var(--texto);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, "Noto Sans";
            touch-action: none;
        }

        /* Canvas a pantalla completa debajo de la interfaz de usuario */
        #contenedor {
            position: fixed;
            inset: 0;
            display: grid;
            place-items: center;
        }

        canvas {
            display: block;
            border-radius: 18px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, .45), 0 2px 12px rgba(0, 0, 0, .6) inset;
            background: linear-gradient(135deg, #2a1f3d 0%, #1e1530 50%, #151122 100%);
            width: 100vw;
            height: 100vh;
        }

        .interfazUsuario {
            position: fixed;
            top: env(safe-area-inset-top);
            margin-top: 10%;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            pointer-events: none;
            z-index: 10;
        }

        .chip {
            margin-top: 20px;
            background: rgba(0, 0, 0, .35);
            border: 1px solid rgba(255, 255, 255, .15);
            border-radius: 999px;
            padding: 8px 14px;
            font-weight: 700;
            font-size: 14px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, .25);
        }

        .barra-superior {
            position: fixed;
            top: calc(env(safe-area-inset-top) + 8px);
            right: 8px;
            display: flex;
            gap: 8px;
            z-index: 11;
        }

        .pildora {
            background: rgba(0, 0, 0, .35);
            border: 1px solid rgba(255, 255, 255, .15);
            color: #fff;
            border-radius: 999px;
            padding: 8px 12px;
            font-weight: 800;
            font-size: 14px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, .25);
            cursor: pointer;
        }

        .controles {
            position: fixed;
            left: 0;
            right: 0;
            bottom: calc(env(safe-area-inset-bottom) + 12px);
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 0 12px;
            z-index: 10;
        }

        .btn {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px 24px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(180deg, rgba(255, 255, 255, .12), rgba(255, 255, 255, .04));
            color: #fff;
            font-size: 16px;
            font-weight: 800;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            touch-action: manipulation;
            cursor: pointer;
        }

        .btn:active {
            transform: translateY(1px);
            filter: brightness(1.15);
        }

        .btn.acento {
            background: linear-gradient(90deg, var(--acento-1), var(--acento-2));
        }

        #superposicion {
            position: fixed;
            inset: 0;
            display: grid;
            place-items: center;
            background: rgba(0, 0, 0, .5);
            z-index: 20;
        }

        #superposicion[hidden] {
            display: none;
        }

        .panel {
            background: var(--panel);
            border: 1px solid rgba(255, 255, 255, .12);
            padding: 22px 22px;
            border-radius: 16px;
            text-align: center;
            width: min(90vw, 380px);
            margin-bottom: env(safe-area-inset-bottom);
        }

        .panel h1 {
            margin: 0 0 10px 0;
            color: #ff7aa2;
            font-size: 26px;
        }

        .linea {
            margin: 6px 0;
            color: var(--atenuado);
        }

        .frase {
            margin: 12px 0 18px 0;
            font-style: italic;
            color: #ffe3ea;
        }

        .cta {
            background: linear-gradient(90deg, var(--acento-1), var(--acento-2));
            border: none;
            color: #fff;
            padding: 12px 16px;
            border-radius: 999px;
            font-weight: 800;
            cursor: pointer;
        }

        #pantallaInicio {
            position: fixed;
            inset: 0;
            display: grid;
            place-items: center;
            background: rgba(0, 0, 0, .85);
            z-index: 30;
        }

        #pantallaInicio[hidden] {
            display: none;
        }

        .panel-inicio {
            background: var(--panel);
            border: 1px solid rgba(255, 255, 255, .12);
            padding: 30px 25px;
            border-radius: 16px;
            text-align: center;
            width: min(90vw, 310px);
        }

        .panel-inicio h1 {
            margin: 0 0 15px 0;
            color: #ff7aa2;
            font-size: 28px;
        }

        .instrucciones {
            margin: 15px 0 20px 0;
            text-align: left;
            color: #ffe3ea;
            font-size: 15px;
            line-height: 1.5;
        }

        .instrucciones li {
            margin-bottom: 8px;
        }

        .mensaje-temporal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ff4d6d;
            border-radius: 12px;
            padding: 20px 30px;
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            text-align: center;
            z-index: 100;
            animation: fadeInOut 2s ease-in-out;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }

            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }

            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        .vidas {
            position: fixed;
            top: calc(env(safe-area-inset-top) + 8px);
            left: 8px;
            background: rgba(0, 0, 0, .35);
            border: 1px solid rgba(255, 255, 255, .15);
            border-radius: 999px;
            padding: 8px 12px;
            font-weight: 800;
            font-size: 14px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, .25);
            z-index: 11;
        }
    </style>
</head>

<body>
    <div id="contenedor">
        <canvas id="juego" aria-label="Juego Match-3 de corazones"></canvas>
    </div>

    <div class="interfazUsuario">
        <div class="chip" id="IUPuntaje">Nivel: 1 ‚Ä¢ Puntaje: 0 ‚Ä¢ Movimientos: 25</div>
    </div>

    <div class="vidas" id="IUVidas">üíñ 5</div>

    <div class="barra-superior">
        <button id="btnReiniciar" class="pildora">üîÑ Reiniciar</button>
        <button id="btnPista" class="pildora">üí° Pista</button>
    </div>

    <div class="controles">
        <button class="btn" id="btnBooster1">üî• Tinder</button>
        <button class="btn" id="btnBooster2">üèπ Cupido</button>
        <button class="btn" id="btnBooster3">‚ú® Big Bang</button>
    </div>

    <div id="pantallaInicio">
        <div class="panel-inicio">
            <h1>Love Crush üíï</h1>
            <div class="instrucciones">
                <p><strong>C√≥mo jugar:</strong></p>
                <ul>
                    <li>ü©∑ Intercambia corazones adyacentes para hacer match de 3+</li>
                    <li>üíò 4 en l√≠nea = Coraz√≥n Rayado (destruye fila/columna)</li>
                    <li>üíù Forma L/T = Coraz√≥n Envuelto (explosi√≥n 3x3)</li>
                    <li>‚ù§Ô∏è‚Äçüî• 5 en l√≠nea = Coraz√≥n Dorado (destruye todos del color)</li>
                    <li>üñ§ Rompe Corazones de Piedra con matches adyacentes</li>
                    <li>üíã Lleva los besos abajo para completar el nivel</li>
                    <li>üß∏ Une las almas gemelas toc√°ndolas</li>
                    <li>üíñ Tienes 5 vidas - ¬°√∫salas sabiamente!</li>
                </ul>
            </div>
            <button id="btnComenzar" class="cta">üíï Comenzar</button>
        </div>
    </div>

    <div id="superposicion" hidden>
        <div class="panel">
            <h1 id="tituloSuperposicion">üíî Nivel Fallido</h1>
            <p class="linea">Nivel: <b id="nivelActual">1</b></p>
            <p class="linea">Puntaje: <b id="puntajeActual">0</b></p>
            <p class="linea">Objetivo: <b id="objetivoTexto">Alcanzar puntuaci√≥n</b></p>
            <p class="frase" id="fraseFinal">"El amor verdadero nunca se rinde üíï"</p>
            <button id="btnContinuar" class="cta">Continuar</button>
        </div>
    </div>

    <script>
        // === Constantes del juego ===
        const MUNDO_ANCHO = 600;
        const MUNDO_ALTO = 775;
        const FILAS = 8;
        const COLUMNAS = 7;
        const TAMA√ëO_CELDA = 60;
        const MARGEN_X = (MUNDO_ANCHO - COLUMNAS * TAMA√ëO_CELDA) / 2;
        const MARGEN_Y = 120;

        // Tipos de corazones
        const CORAZONES_BASICOS = ['ü©∑', 'üß°', 'üíõ', 'üíö', 'ü©µ', 'üíú'];
        const CORAZONES_ESPECIALES = {
            RAYADO: 'üíò',
            ENVUELTO: 'üíù',
            DORADO: '‚ù§Ô∏è‚Äçüî•'
        };

        // Obst√°culos y objetivos
        const ELEMENTOS = {
            PIEDRA: 'üñ§',
            NUBE: '‚òÅÔ∏è',
            MURO: 'üß±',
            BESO: 'üíã',
            ALMA: 'üß∏'
        };

        // Referencias DOM
        const lienzo = document.getElementById('juego');
        const contexto = lienzo.getContext('2d');
        const IUPuntaje = document.getElementById('IUPuntaje');
        const IUVidas = document.getElementById('IUVidas');
        const pantallaInicio = document.getElementById('pantallaInicio');
        const superposicion = document.getElementById('superposicion');
        const btnComenzar = document.getElementById('btnComenzar');
        const btnContinuar = document.getElementById('btnContinuar');
        const btnReiniciar = document.getElementById('btnReiniciar');
        const btnPista = document.getElementById('btnPista');

        // Estado del juego
        let tablero = [];
        let nivel = 1;
        let puntaje = 0;
        let movimientos = 25;
        let vidas = 5;
        let juegoIniciado = false;
        let seleccionado = null;
        let animando = false;
        let objetivo = 'puntuacion';
        let objetivoValor = 5000;
        let particulas = [];
        let efectosVisuales = [];

        // Variables responsive
        let dpr = 1;
        let escala = 1;
        let desplazamientoX = 0;
        let desplazamientoY = 0;

        // Audio simple con Web Audio API
        let audioCtx = null;
        let masterGain = null;

        async function setupAudio() {
            if (audioCtx) return;
            const AC = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AC();
            masterGain = audioCtx.createGain();
            masterGain.gain.value = 0.3;
            masterGain.connect(audioCtx.destination);
        }

        function playTone(frequency, duration = 0.1, type = 'sine') {
            if (!audioCtx) return;
            try {
                const osc = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                osc.type = type;
                osc.frequency.setValueAtTime(frequency, audioCtx.currentTime);
                osc.connect(gainNode);
                gainNode.connect(masterGain);

                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);

                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + duration);
            } catch (e) { }
        }

        function playSoundEffect(type) {
            if (!audioCtx) return;

            switch (type) {
                case 'match':
                    playTone(523, 0.15); // Do
                    setTimeout(() => playTone(659, 0.15), 50); // Mi
                    break;
                case 'special':
                    playTone(659, 0.2); // Mi
                    setTimeout(() => playTone(784, 0.2), 100); // Sol
                    setTimeout(() => playTone(988, 0.3), 200); // Si
                    break;
                case 'fail':
                    playTone(208, 0.5); // Sol bemol grave
                    break;
                case 'success':
                    playTone(523, 0.2); // Do
                    setTimeout(() => playTone(659, 0.2), 100); // Mi
                    setTimeout(() => playTone(784, 0.2), 200); // Sol
                    setTimeout(() => playTone(1047, 0.4), 300); // Do alto
                    break;
            }
        }

        // Funciones de utilidad
        function aleatorio(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function elegirAleatorio(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function vibrar(duracion) {
            if (navigator.vibrate) navigator.vibrate(duracion);
        }

        function mostrarMensaje(texto) {
            const mensaje = document.createElement('div');
            mensaje.className = 'mensaje-temporal';
            mensaje.textContent = texto;
            document.body.appendChild(mensaje);

            setTimeout(() => {
                if (mensaje.parentNode) {
                    mensaje.parentNode.removeChild(mensaje);
                }
            }, 2000);
        }

        // Responsive
        function redimensionar() {
            const cssAncho = window.innerWidth;
            const cssAlto = window.innerHeight;
            dpr = Math.min(window.devicePixelRatio || 1, 3);

            lienzo.width = Math.floor(cssAncho * dpr);
            lienzo.height = Math.floor(cssAlto * dpr);

            const escalaX = cssAncho / MUNDO_ANCHO;
            const escalaY = cssAlto / MUNDO_ALTO;
            escala = Math.min(escalaX, escalaY);

            desplazamientoX = (cssAncho - MUNDO_ANCHO * escala) / 2;
            desplazamientoY = (cssAlto - MUNDO_ALTO * escala) / 2;
        }

        function establecerTransformacionMundo() {
            contexto.setTransform(dpr, 0, 0, dpr, 0, 0);
            contexto.translate(desplazamientoX, desplazamientoY);
            contexto.scale(escala, escala);
        }

        // Inicializaci√≥n del tablero
        function crearTablero() {
            tablero = [];
            for (let fila = 0; fila < FILAS; fila++) {
                tablero[fila] = [];
                for (let col = 0; col < COLUMNAS; col++) {
                    let corazon;
                    do {
                        corazon = elegirAleatorio(CORAZONES_BASICOS);
                    } while (verificarMatchInicial(fila, col, corazon));

                    tablero[fila][col] = corazon;
                }
            }
        }

        function verificarMatchInicial(fila, col, corazon) {
            // Verificar horizontal
            if (col >= 2 &&
                tablero[fila][col - 1] === corazon &&
                tablero[fila][col - 2] === corazon) {
                return true;
            }

            // Verificar vertical
            if (fila >= 2 &&
                tablero[fila - 1][col] === corazon &&
                tablero[fila - 2][col] === corazon) {
                return true;
            }

            return false;
        }

        // Obtener posici√≥n del tablero desde coordenadas del canvas
        function obtenerPosicionTablero(x, y) {
            const col = Math.floor((x - MARGEN_X) / TAMA√ëO_CELDA);
            const fila = Math.floor((y - MARGEN_Y) / TAMA√ëO_CELDA);

            if (col >= 0 && col < COLUMNAS && fila >= 0 && fila < FILAS) {
                return { fila, col };
            }
            return null;
        }

        // Manejo de eventos
        function configurarEventos() {
            lienzo.addEventListener('pointerdown', manejarClick);
            btnComenzar.addEventListener('click', iniciarJuego);
            btnContinuar.addEventListener('click', continuarJuego);
            btnReiniciar.addEventListener('click', reiniciarNivel);
            btnPista.addEventListener('click', mostrarPista);

            // Boosters
            document.getElementById('btnBooster1').addEventListener('click', () => usarBooster('tinder'));
            document.getElementById('btnBooster2').addEventListener('click', () => usarBooster('cupido'));
            document.getElementById('btnBooster3').addEventListener('click', () => usarBooster('bigbang'));
        }

        function manejarClick(e) {
            if (!juegoIniciado || animando) return;

            e.preventDefault();

            const rect = lienzo.getBoundingClientRect();
            const x = (e.clientX - rect.left - desplazamientoX) / escala;
            const y = (e.clientY - rect.top - desplazamientoY) / escala;

            const pos = obtenerPosicionTablero(x, y);
            if (!pos) return;

            if (!seleccionado) {
                // Primer click - seleccionar
                seleccionado = pos;
                playTone(440, 0.1);
            } else {
                // Segundo click - intentar intercambio
                if (pos.fila === seleccionado.fila && pos.col === seleccionado.col) {
                    // Click en la misma celda - deseleccionar
                    seleccionado = null;
                } else if (sonAdyacentes(seleccionado, pos)) {
                    // Intercambiar si son adyacentes
                    intentarIntercambio(seleccionado, pos);
                    seleccionado = null;
                } else {
                    // Seleccionar nueva posici√≥n
                    seleccionado = pos;
                    playTone(440, 0.1);
                }
            }
        }

        function sonAdyacentes(pos1, pos2) {
            const deltaFila = Math.abs(pos1.fila - pos2.fila);
            const deltaCol = Math.abs(pos1.col - pos2.col);

            return (deltaFila === 1 && deltaCol === 0) || (deltaFila === 0 && deltaCol === 1);
        }

        function intentarIntercambio(pos1, pos2) {
            if (animando) return;

            // Intercambiar temporalmente
            const temp = tablero[pos1.fila][pos1.col];
            tablero[pos1.fila][pos1.col] = tablero[pos2.fila][pos2.col];
            tablero[pos2.fila][pos2.col] = temp;

            // Verificar si hay matches
            const matches1 = encontrarMatches(pos1.fila, pos1.col);
            const matches2 = encontrarMatches(pos2.fila, pos2.col);

            if (matches1.length > 0 || matches2.length > 0) {
                // Movimiento v√°lido
                movimientos--;
                actualizarUI();
                procesarMatches();
                playSoundEffect('match');
                vibrar(30);
            } else {
                // Movimiento inv√°lido - revertir
                tablero[pos2.fila][pos2.col] = tablero[pos1.fila][pos1.col];
                tablero[pos1.fila][pos1.col] = temp;
                playSoundEffect('fail');
            }
        }

        // Sistema de matches
        function encontrarMatches(fila, col) {
            const corazon = tablero[fila][col];
            if (!CORAZONES_BASICOS.includes(corazon)) return [];

            let matches = [];

            // Buscar horizontal
            let horizontal = [{ fila, col }];

            // Izquierda
            for (let c = col - 1; c >= 0; c--) {
                if (tablero[fila][c] === corazon) {
                    horizontal.unshift({ fila, col: c });
                } else {
                    break;
                }
            }

            // Derecha
            for (let c = col + 1; c < COLUMNAS; c++) {
                if (tablero[fila][c] === corazon) {
                    horizontal.push({ fila, col: c });
                } else {
                    break;
                }
            }

            if (horizontal.length >= 3) {
                matches = matches.concat(horizontal);
            }

            // Buscar vertical
            let vertical = [{ fila, col }];

            // Arriba
            for (let f = fila - 1; f >= 0; f--) {
                if (tablero[f][col] === corazon) {
                    vertical.unshift({ fila: f, col });
                } else {
                    break;
                }
            }

            // Abajo
            for (let f = fila + 1; f < FILAS; f++) {
                if (tablero[f][col] === corazon) {
                    vertical.push({ fila: f, col });
                } else {
                    break;
                }
            }

            if (vertical.length >= 3) {
                matches = matches.concat(vertical);
            }

            // Remover duplicados
            const uniqueMatches = [];
            matches.forEach(match => {
                if (!uniqueMatches.some(m => m.fila === match.fila && m.col === match.col)) {
                    uniqueMatches.push(match);
                }
            });

            return uniqueMatches;
        }

        function encontrarTodosLosMatches() {
            let todosLosMatches = [];

            for (let fila = 0; fila < FILAS; fila++) {
                for (let col = 0; col < COLUMNAS; col++) {
                    const matches = encontrarMatches(fila, col);
                    matches.forEach(match => {
                        if (!todosLosMatches.some(m => m.fila === match.fila && m.col === match.col)) {
                            todosLosMatches.push(match);
                        }
                    });
                }
            }

            return todosLosMatches;
        }

        function procesarMatches() {
            animando = true;

            setTimeout(() => {
                let matches = encontrarTodosLosMatches();

                if (matches.length > 0) {
                    // Crear efectos especiales basados en el patr√≥n
                    crearEfectosEspeciales(matches);

                    // Eliminar matches y sumar puntos
                    matches.forEach(match => {
                        crearParticulas(match.fila, match.col);
                        tablero[match.fila][match.col] = null;
                        puntaje += 100;
                    });

                    actualizarUI();

                    // Aplicar gravedad
                    aplicarGravedad();

                    // Llenar espacios vac√≠os
                    llenarEspaciosVacios();

                    // Buscar m√°s matches despu√©s de un delay
                    setTimeout(() => {
                        procesarMatches();
                    }, 300);
                } else {
                    animando = false;
                    verificarEstadoJuego();
                }
            }, 200);
        }

        function crearEfectosEspeciales(matches) {
            // Buscar patrones especiales
            const grupos = agruparMatchesPorLinea(matches);

            grupos.forEach(grupo => {
                if (grupo.length === 4) {
                    // Crear coraz√≥n rayado
                    const pos = grupo[Math.floor(grupo.length / 2)];
                    setTimeout(() => {
                        tablero[pos.fila][pos.col] = CORAZONES_ESPECIALES.RAYADO;
                    }, 250);
                    mostrarMensaje('¬°Coraz√≥n Rayado! üíò');
                } else if (grupo.length === 5) {
                    // Crear coraz√≥n dorado
                    const pos = grupo[Math.floor(grupo.length / 2)];
                    setTimeout(() => {
                        tablero[pos.fila][pos.col] = CORAZONES_ESPECIALES.DORADO;
                    }, 250);
                    mostrarMensaje('¬°Coraz√≥n Dorado! ‚ù§Ô∏è‚Äçüî•');
                    playSoundEffect('special');
                }
                // Para el coraz√≥n envuelto (L o T) necesitar√≠amos una l√≥gica m√°s compleja
            });
        }

        function agruparMatchesPorLinea(matches) {
            const grupos = [];
            const procesados = new Set();

            matches.forEach(match => {
                const key = `${match.fila}-${match.col}`;
                if (procesados.has(key)) return;

                // Buscar grupo horizontal
                let grupoH = matches.filter(m =>
                    m.fila === match.fila &&
                    Math.abs(m.col - match.col) <= 2
                ).sort((a, b) => a.col - b.col);

                if (grupoH.length >= 3) {
                    grupos.push(grupoH);
                    grupoH.forEach(m => procesados.add(`${m.fila}-${m.col}`));
                }

                // Buscar grupo vertical
                let grupoV = matches.filter(m =>
                    m.col === match.col &&
                    Math.abs(m.fila - match.fila) <= 2 &&
                    !procesados.has(`${m.fila}-${m.col}`)
                ).sort((a, b) => a.fila - b.fila);

                if (grupoV.length >= 3) {
                    grupos.push(grupoV);
                    grupoV.forEach(m => procesados.add(`${m.fila}-${m.col}`));
                }
            });

            return grupos;
        }

        // Gravedad y llenado
        function aplicarGravedad() {
            for (let col = 0; col < COLUMNAS; col++) {
                let vacios = 0;

                // Contar espacios vac√≠os desde abajo hacia arriba
                for (let fila = FILAS - 1; fila >= 0; fila--) {
                    if (tablero[fila][col] === null) {
                        vacios++;
                    } else if (vacios > 0) {
                        // Mover elemento hacia abajo
                        tablero[fila + vacios][col] = tablero[fila][col];
                        tablero[fila][col] = null;
                    }
                }
            }
        }

        function llenarEspaciosVacios() {
            for (let col = 0; col < COLUMNAS; col++) {
                for (let fila = 0; fila < FILAS; fila++) {
                    if (tablero[fila][col] === null) {
                        tablero[fila][col] = elegirAleatorio(CORAZONES_BASICOS);
                    }
                }
            }
        }

        // Sistema de part√≠culas para efectos visuales
        function crearParticulas(fila, col) {
            const x = MARGEN_X + col * TAMA√ëO_CELDA + TAMA√ëO_CELDA / 2;
            const y = MARGEN_Y + fila * TAMA√ëO_CELDA + TAMA√ëO_CELDA / 2;

            for (let i = 0; i < 15; i++) {
                particulas.push({
                    x,
                    y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    radio: Math.random() * 3 + 1,
                    color: tablero[fila][col],
                    vida: 30
                });
            }
        }

        function actualizarParticulas() {
            for (let i = particulas.length - 1; i >= 0; i--) {
                const p = particulas[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vx *= 0.95;
                p.vy *= 0.95;
                p.vida--;

                if (p.vida <= 0) {
                    particulas.splice(i, 1);
                }
            }
        }

        // UI y estado del juego
        function actualizarUI() {
            IUPuntaje.textContent = `Nivel: ${nivel} ‚Ä¢ Puntaje: ${puntaje} ‚Ä¢ Movimientos: ${movimientos}`;
            IUVidas.textContent = `üíñ ${vidas}`;
        }

        function verificarEstadoJuego() {
            if (movimientos <= 0) {
                if (puntaje >= objetivoValor) {
                    // Victoria
                    mostrarSuperposicion('¬°Nivel Completado! üíï', '¬°Eres un experto en amor! üíò');
                } else {
                    // Derrota
                    vidas--;
                    mostrarSuperposicion('üíî Nivel Fallido', 'El amor verdadero nunca se rinde üíï');
                }
            } else if (puntaje >= objetivoValor) {
                // Victoria por alcanzar puntuaci√≥n
                mostrarSuperposicion('¬°Nivel Completado! üíï', '¬°Eres un experto en amor! üíò');
            }
        }

        function mostrarSuperposicion(titulo, frase) {
            document.getElementById('tituloSuperposicion').textContent = titulo;
            document.getElementById('nivelActual').textContent = nivel;
            document.getElementById('puntajeActual').textContent = puntaje;
            document.getElementById('objetivoTexto').textContent = `Alcanzar ${objetivoValor} puntos`;
            document.getElementById('fraseFinal').textContent = frase;
            superposicion.hidden = false;
        }

        // Funciones de juego
        function iniciarJuego() {
            pantallaInicio.hidden = true;
            juegoIniciado = true;
            setupAudio();
            crearTablero();
            actualizarUI();
            buclePrincipal();
        }

        function continuarJuego() {
            superposicion.hidden = true;
            if (vidas <= 0) {
                // Game over
                vidas = 5;
                nivel = 1;
                puntaje = 0;
                movimientos = 25;
                crearTablero();
            } else if (puntaje >= objetivoValor) {
                // Siguiente nivel
                nivel++;
                movimientos = 25;
                objetivoValor = Math.floor(objetivoValor * 1.3);
                crearTablero();
            } else {
                // Reintentar nivel
                movimientos = 25;
                crearTablero();
            }
            actualizarUI();
        }

        function reiniciarNivel() {
            if (animando) return;
            movimientos = 25;
            puntaje = 0;
            crearTablero();
            actualizarUI();
        }

        function mostrarPista() {
            // Implementar l√≥gica para mostrar pistas
            mostrarMensaje('üí° Encuentra matches de 4 o m√°s!');
        }

        function usarBooster(tipo) {
            if (animando) return;

            switch (tipo) {
                case 'tinder':
                    mostrarMensaje('üî• Tinder M√°gico activado!');
                    break;
                case 'cupido':
                    mostrarMensaje('üèπ Ojo de Cupido activado!');
                    break;
                case 'bigbang':
                    mostrarMensaje('‚ú® Big Bang Amoroso activado!');
                    break;
            }
        }

        // Bucle principal
        function buclePrincipal() {
            // Reset de la transformaci√≥n antes de cada frame
            contexto.setTransform(1, 0, 0, 1, 0, 0);
            contexto.clearRect(0, 0, lienzo.width, lienzo.height);

            // Aplicar transformaciones al "mundo" escalado
            establecerTransformacionMundo();

            // Dibujar tablero
            for (let fila = 0; fila < FILAS; fila++) {
                for (let col = 0; col < COLUMNAS; col++) {
                    const corazon = tablero[fila][col];
                    if (corazon) {
                        const x = MARGEN_X + col * TAMA√ëO_CELDA;
                        const y = MARGEN_Y + fila * TAMA√ëO_CELDA;

                        contexto.font = "40px serif";
                        contexto.textAlign = "center";
                        contexto.textBaseline = "middle";
                        contexto.fillText(corazon, x + TAMA√ëO_CELDA / 2, y + TAMA√ëO_CELDA / 2);
                    }
                }
            }

            // Actualizar y dibujar part√≠culas
            actualizarParticulas();
            particulas.forEach(p => {
                contexto.globalAlpha = p.vida / 30;
                contexto.beginPath();
                contexto.arc(p.x, p.y, p.radio, 0, Math.PI * 2);
                contexto.fillStyle = "#ff6b9d";
                contexto.fill();
                contexto.globalAlpha = 1;
            });

            requestAnimationFrame(buclePrincipal);
        }


        // Inicializaci√≥n
        function inicializar() {
            redimensionar();
            window.addEventListener('resize', redimensionar);
            configurarEventos();
            actualizarUI();
        }

        // Iniciar cuando el documento est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializar);
        } else {
            inicializar();
        }
    </script>
</body>

</html>